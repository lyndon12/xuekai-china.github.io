<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>SoonSpace Example</title>
  <link rel="stylesheet" href="../../asstes/css/base.css">
</head>

<body>
  <div id="view"></div>

  <script src="../../sdk/index.js"></script>
  <script src="../../../package/soon-gui/index.js"></script>
  <script>

    let pathGroup = null
    let shortestPath = null
    let patrol = null
    let isPause = false
    let dot = null

    const gui = new GUI({
      el: '#view'
    })

    const getPathBtn = gui.addButton({
      text: '获取最短路径',
      onClick() {
        if (!pathGroup) alert('请等待模型与路径加载完成后再试！')

        shortestPath = ssp.getShortestPath({
          topology: pathGroup.children[0],
          positions: {
            start: {
              x: 2573,
              y: 2,
              z: -582
            },
            end: {
              x: 4522,
              y: 2,
              z: 5257
            }
          },
          restrict: null,
          color: 0xff0000
        })

        console.log(shortestPath)

        if (!!shortestPath) {

          startBtn.show()

        } else {

          alert('未能计算出俩点直接的最短路径！')

        }
      }
    })

    const startBtn = gui.addButton({
      text: '开始导航',
      hide: true,
      onClick() {

        // 圆点
        dot = ssp.renderPoints({
          points: [{ x: 0, y: 20, z: 0 }],
          id: 'points',
          size: 20,
          color: 'yellow'
        })

        // 箭头
        const imgEl = document.createElement('img')
        imgEl.width = 100
        imgEl.height = 100
        imgEl.src = 'https://ss0.bdstatic.com/70cFuHSh_Q1YnxGkpoWK1HF6hhy/it/u=593574568,3355290888&fm=15&gp=0.jpg'

        const arrow = ssp.createPoiNode({
          type: '3D',
          id: 'patrolArrow',
          element: imgEl,
          position: {
            x: 10,
            y: 0,
            z: 10
          },
          rotation: {
            x: Math.PI / 2,
            y: 0,
            z: 0
          }
        })

        // 把箭头加到圆点内部
        dot.add(arrow)

        patrol = ssp.autoPatrol({
          mode: 'thirdPerson',
          lookAtY: 0,
          path: shortestPath,
          naviSpeed: 1,
          navigatedOption: {
            radius: 20,
            color: 'yellow'
          },
          person: dot,
          onEnd: () => console.log('onEnd')
        })

        // 模拟箭头角度旋转
        mockArrowRotate(arrow, ssp)

        pauseBtn.show()
        stopBtn.show()

      }
    })

    const pauseBtn = gui.addButton({
      text: '暂停',
      hide: true,
      onClick() {

        isPause = !isPause

        if (isPause) {

          patrol.pause()
          pauseBtn.innerHTML = '开始'

        } else {

          patrol.following()
          pauseBtn.innerHTML = '暂停'

        }

      }
    })

    const stopBtn = gui.addButton({
      text: '停止',
      hide: true,
      onClick() {
        patrol.stop()

        pathGroup = null
        shortestPath = null
        patrol = null
        isPause = false

        startBtn.hide()
        pauseBtn.hide()
        stopBtn.hide()
      }
    })

    // 模拟箭头角度旋转
    function mockArrowRotate(arrow, ssp) {
      // 一个单位旋转弧度
      const oneDeg = Math.PI / 188

      // 0 到 360 的随机树数
      function getRandom0To360() {

        const a = Math.floor(Math.random() * 4) * 100
        const b = Math.floor(Math.random() * 7) * 10

        let c = 0

        if (a !== 300 || b !== 60) c = Math.floor(Math.random() * 10)

        return a + b + c

      }

      // 每秒随机改变箭头的方向
      setInterval(() => {

        ssp.nextRender(() => {

          arrow.rotation.z = getRandom0To360() * oneDeg

        })

      }, 1000)
    }

    const ssp = new SoonSpace({
      el: '#view',
      option: {
        showInfo: true
      },
      events: {}
    })

    ssp.loadXml({ id: 'xml' }, '../../asstes/model/sbm/hzl/hzl.xml')
      .then(() => ssp.loadGml({ id: 'gml' }, '../../asstes/model/sbm/hzl/hzl.gml'))
      .then(group => {

        pathGroup = group

        ssp.flyMainViewpoint()

      })
  </script>
</body>

</html>