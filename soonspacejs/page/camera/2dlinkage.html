<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>SoonSpace Example</title>
  <link rel="stylesheet" href="../../asstes/css/base.css">
  <link rel="stylesheet" href="../../lib/antd-vue/antd.min.css">
</head>
<!-- 引入在线资源 -->
<script src="https://gw.alipayobjects.com/os/antv/assets/f2/3.4.2/f2.min.js"></script>
<!-- 友情提醒：请按需更新版本号。 -->
<style>
  #rect{
    top: 52px;
    background: white;
    opacity: 0.8;
  }
</style>
<body>
  <div id="view"></div>
  <div id="app"></div>
  <canvas id="myLine" width="3400" height="260" style="position: absolute;"></canvas>
  <div id="rect" style="position: absolute;height: 200px;width: 400px;left: 800px;"></div>
  
  <script src="https://unpkg.com/babel-polyfill/dist/polyfill.js"></script>
  <script src="../../lib/vue/vue.min.js"></script>
  <script src="../../lib/antd-vue/antd.min.js"></script>
  <script src="../../sdk/index.js"></script>
  <script>
        
    let context = document.getElementById('myLine');
    var ctx = context.getContext("2d");
    ctx.strokeStyle="#00FF00"
    ctx.lineWidth = 10; 
    ctx.beginPath(); 
    ctx.moveTo(10, 100); 
    ctx.lineTo(900,100); 
    ctx.stroke(); 
    ctx.beginPath();  
    ctx.moveTo(900,100); 
    ctx.lineTo(1000,100);  
    ctx.strokeStyle = "blue";   
    ctx.stroke();  
    
    ctx.beginPath(); 
    ctx.moveTo(1000,100); 
    ctx.lineTo(1920,100);  
    ctx.strokeStyle = "#00FF00";    
    ctx.stroke();

    ctx.beginPath(); 
    ctx.moveTo(10, 200); 
    ctx.lineTo(900,200); 
    ctx.stroke(); 
    ctx.beginPath();  
    ctx.moveTo(900,200); 
    ctx.lineTo(1000,200);  
    ctx.strokeStyle = "blue";   
    ctx.stroke();  
    
    ctx.beginPath(); 
    ctx.moveTo(1000,200); 
    ctx.lineTo(1920,200);  
    ctx.strokeStyle = "#00FF00";    
    ctx.stroke();


    const vm = new Vue({
      el: '#app',
      template:
        `
  <div id="app" v-if="loading">
    <div class="progress-container">
      <div class="progress-warp ">
        <div style="width: 600px; display: inline-block;">
          <span style="color: #fff">已加载模型数量：{{ progress.loadingModelIndex }} / {{ progress.modelTotal }}</span>
          <br/>
          <span style="color: #fff">单次加载用时：{{ progress.current.timeStamp }} ms</span>
          <a-progress :percent="percent" />
        </div>
      </div>
    </div>
  </div>
  `,
      data: {
        loading: true,
        progress: {
          current: {
            loaded: 0,
            total: 0,
            timeStamp: 0
          },
          loadingModelIndex: 0,
          modelTotal: 0
        },
        percent: 0
      },
      watch: {
        progress: function (val) {
          const { progress } = this
          this.percent = (100 / progress.modelTotal) * (progress.loadingModelIndex - 1) + ((100 / progress.modelTotal) * (progress.current.loaded / progress.current.total))
        }
      }
    })

    const ssp = new SoonSpace({
      el: '#view',
      option: {
        showInfo: true,
        showGrid: true,
        ,
        useIndexedDB: true
      },
      events: {}
    })

    const baseUrl = '../../asstes/model/sbm/yingtaidasha'
    const mapsUrl = `${baseUrl}/Maps/`
    const sbmsInfo = [
      {
        id: 'B1_0',
        name: 'B1',
        url: `${baseUrl}/yingtaidasha_B1_0.sbm`,
        mapsUrl,
        position: { x: 10000, y: 0, z: 10000 },
        userData: {
          modelCode: 'njnkjnkjnjdnkjnkjnm'
        }
      },
      {
        id: '1F',
        name: '1F',
        url: `${baseUrl}/yingtaidasha_1F_1.sbm`,
        mapsUrl,
        userData: {
          aaaaaaa: 'a'
        }
      },
      {
        id: '2F',
        name: '2F',
        url: `${baseUrl}/yingtaidasha_2F_2.sbm`,
        mapsUrl
      },
      {
        id: '3F',
        name: '3F',
        url: `${baseUrl}/yingtaidasha_3F_3.sbm`,
        mapsUrl
      },
      {
        id: '4F',
        name: '4F',
        url: `${baseUrl}/yingtaidasha_4F_4.sbm`,
        mapsUrl
      },
      {
        id: '5F',
        name: '5F',
        url: `${baseUrl}/yingtaidasha_5F_5.sbm`,
        mapsUrl
      },
      {
        id: '6F',
        name: '6F',
        url: `${baseUrl}/yingtaidasha_6F_6.sbm`,
        mapsUrl
      },
      {
        id: '7F',
        name: '7F',
        url: `${baseUrl}/yingtaidasha_7F_7.sbm`,
        mapsUrl
      }
      // ...
    ]

    // /**
    //  * 加载 sbm˝
    //  */
    // ssp.loadSbm(
    //   sbmsInfo,
    //   progress => console.log('loding:', JSON.parse(JSON.stringify(progress)))
    // )
    //   .then(models => {
    //     console.log('loaded models:', models)
    //   })

    /**
     * 加载 sbm 到组内
     */
     let mins = [];
      let maxs = [];

    ssp.loadSbmToGroup(
      // groupParam
      {
        id: 'firstSbmGroup',
        name: 'name_firstSbmGroup',
        scale: {
          x: 10,
          y: 10,
          z: 10
        }
      },
      // sbmParam
      sbmsInfo,
      progress => vm.progress = JSON.parse(JSON.stringify(progress))
    )
      .then(group => {

        return ssp.addSbmForGroup(
          'firstSbmGroup',
          [
            {
              id: 'B1_0',
              name: 'B1',
              url: `${baseUrl}/yingtaidasha_22F_22.sbm`,
              mapsUrl,
              position: { x: 5000, y: 0, z: 5000 },
              userData: {
                modelCode: 'njnkjnkjnjdnkjnkjnm'
              }
            }
          ],
          progress => vm.progress = JSON.parse(JSON.stringify(progress))
        )
      })
      .then(group => {
        console.log('addSbmForGroup', group.children[1])
        group.children[0].visible = false

        var material = new ssp.viewport.THREE.MeshBasicMaterial( { color: 0xff0000 } );
        material.needsUpdate = true;
        let child = group.children[1];
        child.children[1].material = material;
        child.children[2].material = material;
        child.children[3].material = material;

        vm.loading = false

        ssp.flyToObj(group)
      
        for(var i in group.children) {
          let child = group.children[i].children;
          if(child.length > 0) {
            for(var j in child){
              mins.push(child[j].geometry.boundingBox.min.x);
              maxs.push(child[j].geometry.boundingBox.max.x);

            }
          }
        }
      })
      .catch(err => console.error(err))

      let control = ssp.viewport.cameraControlerManager.controlsManager.fullFreeControler;
      control.enablePanY = false;
      control.onProgress = (x,y) => {
          let left = Number(dom.style.left.substring(0,dom.style.left.length-2));
          left += x;
          dom.style.left = left + 'px';
      }

      let dom = document.getElementById('rect');
      let is2dMove = false;
      let lastMove = undefined;
      dom.onmousedown = () => {
        is2dMove = true;

        mins.sort();
        maxs.sort();
        // console.info(maxs[maxs.length-1])
        // console.info(ssp.viewport.camera)
      }

      window.onmousemove = (event) => {
        if(is2dMove){
          // let per = event.clientX / window.innerWidth;
          if(lastMove){
            // ssp.viewport.camera.translateX((lastMove - event.clientX)*80)
            control.parallelpan( new  ssp.viewport.THREE.Vector3( (lastMove - event.clientX)/2, 0, 0 ) )
            ssp.viewport.trigerRender()

            let left = Number(dom.style.left.substring(0,dom.style.left.length-2));
            left += event.clientX - lastMove;
            dom.style.left = left + 'px';
            
          }
          lastMove = event.clientX;

        }
      }

      window.onmouseup = () => {
        is2dMove = false;
        lastMove = undefined;
      }
  </script>
</body>

</html>